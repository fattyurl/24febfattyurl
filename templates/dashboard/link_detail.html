{% extends "base.html" %}
{% load core_tags %}

{% block title %}Analytics - {{ link.get_display_code }} - FattyURL{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
        <div>
            <a href="{% url 'dashboard' %}" class="text-indigo-600 hover:text-indigo-800 text-sm mb-2 inline-block">
                <i class="fa-solid fa-arrow-left mr-1"></i>Back to Dashboard
            </a>
            <h1 class="text-2xl font-bold text-gray-900">
                <i class="fa-solid fa-chart-line text-indigo-600 mr-2"></i>{{ link.get_display_code }}
            </h1>
            <p class="text-gray-500 text-sm mt-1 truncate max-w-lg">{{ link.original_url }}</p>
        </div>
        <div class="flex gap-3">
            <button onclick="copyToClipboard('{{ link.get_short_url }}', this)"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                <i class="fa-solid fa-copy mr-1"></i>Copy Link
            </button>
            <a href="{% url 'generate_qr' %}?url={{ link.get_short_url }}&format=png"
               class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200">
                <i class="fa-solid fa-qrcode mr-1"></i>Download QR
            </a>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Total Clicks</p>
            <p class="text-3xl font-bold text-indigo-600">{{ total_clicks }}</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Unique Visitors</p>
            <p class="text-3xl font-bold text-green-600">{{ unique_visitors }}</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Created</p>
            <p class="text-lg font-semibold text-gray-900">{{ link.created_at|date:"M d, Y" }}</p>
        </div>
        <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Lifetime Clicks</p>
            <p class="text-3xl font-bold text-gray-900">{{ link.click_count }}</p>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="flex gap-2 mb-6">
        {% for d in "7,30,90,365"|make_list %}{% endfor %}
        <a href="?days=7" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 7 %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">7 days</a>
        <a href="?days=30" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 30 %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">30 days</a>
        <a href="?days=90" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 90 %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">90 days</a>
        <a href="?days=365" class="px-4 py-2 rounded-lg text-sm font-medium {% if days == 365 %}bg-indigo-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">1 year</a>
    </div>

    <!-- Clicks Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Clicks Over Time</h2>
        <canvas id="clicksChart" height="100"></canvas>
    </div>

    <!-- Data Tables Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Countries -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fa-solid fa-globe mr-2 text-indigo-600"></i>Top Countries</h3>
            {% if top_countries %}
            <table class="w-full">
                {% for item in top_countries %}
                <tr class="border-b border-gray-100 last:border-0">
                    <td class="py-2 text-sm text-gray-700">{{ item.country }}</td>
                    <td class="py-2 text-sm text-gray-500 text-right">{{ item.count }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-gray-400 text-sm">No data yet</p>
            {% endif %}
        </div>

        <!-- Cities -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fa-solid fa-city mr-2 text-indigo-600"></i>Top Cities</h3>
            {% if top_cities %}
            <table class="w-full">
                {% for item in top_cities %}
                <tr class="border-b border-gray-100 last:border-0">
                    <td class="py-2 text-sm text-gray-700">{{ item.city }}</td>
                    <td class="py-2 text-sm text-gray-500 text-right">{{ item.count }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-gray-400 text-sm">No data yet</p>
            {% endif %}
        </div>

        <!-- Devices -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fa-solid fa-laptop-mobile mr-2 text-indigo-600"></i>Devices</h3>
            {% if device_breakdown %}
            <table class="w-full">
                {% for item in device_breakdown %}
                <tr class="border-b border-gray-100 last:border-0">
                    <td class="py-2 text-sm text-gray-700">
                        {% if item.device_type == 'mobile' %}<i class="fa-solid fa-mobile-screen mr-2"></i>
                        {% elif item.device_type == 'tablet' %}<i class="fa-solid fa-tablet-screen-button mr-2"></i>
                        {% elif item.device_type == 'desktop' %}<i class="fa-solid fa-desktop mr-2"></i>
                        {% else %}<i class="fa-solid fa-question mr-2"></i>{% endif %}
                        {{ item.device_type|title }}
                    </td>
                    <td class="py-2 text-sm text-gray-500 text-right">{{ item.count }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-gray-400 text-sm">No data yet</p>
            {% endif %}
        </div>

        <!-- Browsers -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fa-solid fa-window-maximize mr-2 text-indigo-600"></i>Browsers</h3>
            {% if browser_breakdown %}
            <table class="w-full">
                {% for item in browser_breakdown %}
                <tr class="border-b border-gray-100 last:border-0">
                    <td class="py-2 text-sm text-gray-700">{{ item.browser }}</td>
                    <td class="py-2 text-sm text-gray-500 text-right">{{ item.count }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-gray-400 text-sm">No data yet</p>
            {% endif %}
        </div>

        <!-- OS -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fa-solid fa-server mr-2 text-indigo-600"></i>Operating Systems</h3>
            {% if os_breakdown %}
            <table class="w-full">
                {% for item in os_breakdown %}
                <tr class="border-b border-gray-100 last:border-0">
                    <td class="py-2 text-sm text-gray-700">{{ item.os }}</td>
                    <td class="py-2 text-sm text-gray-500 text-right">{{ item.count }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-gray-400 text-sm">No data yet</p>
            {% endif %}
        </div>

        <!-- Referrers -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
            <h3 class="text-md font-semibold text-gray-900 mb-4"><i class="fa-solid fa-arrow-up-right-from-square mr-2 text-indigo-600"></i>Top Referrers</h3>
            {% if top_referrers %}
            <table class="w-full">
                {% for item in top_referrers %}
                <tr class="border-b border-gray-100 last:border-0">
                    <td class="py-2 text-sm text-gray-700 truncate max-w-xs">{{ item.referrer|truncate_url:40 }}</td>
                    <td class="py-2 text-sm text-gray-500 text-right">{{ item.count }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p class="text-gray-400 text-sm">No data yet</p>
            {% endif %}
        </div>
    </div>

    <!-- Edit Link Form -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4"><i class="fa-solid fa-pen mr-2 text-indigo-600"></i>Edit Link</h3>
        <form method="post" action="{% url 'edit_link' link.pk %}" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Destination URL</label>
                {{ edit_form.original_url }}
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Title (optional)</label>
                {{ edit_form.title }}
            </div>
            <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700">
                <i class="fa-solid fa-save mr-1"></i>Save Changes
            </button>
        </form>
    </div>

    <!-- Delete Link -->
    <div class="bg-red-50 rounded-xl border border-red-200 p-6">
        <h3 class="text-lg font-semibold text-red-800 mb-2">Danger Zone</h3>
        <p class="text-red-600 text-sm mb-4">Deactivating this link will make it stop redirecting. The analytics data will be preserved.</p>
        <form method="post" action="{% url 'delete_link' link.pk %}" onsubmit="return confirm('Are you sure you want to deactivate this link?');">
            {% csrf_token %}
            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-700">
                <i class="fa-solid fa-trash mr-1"></i>Deactivate Link
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const ctx = document.getElementById('clicksChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [{
                label: 'Clicks',
                data: {{ chart_data|safe }},
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                fill: true,
                tension: 0.3,
                pointBackgroundColor: '#4f46e5',
                pointRadius: 4,
                pointHoverRadius: 6,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 },
                },
                x: {
                    grid: { display: false },
                }
            }
        }
    });
</script>
{% endblock %}
